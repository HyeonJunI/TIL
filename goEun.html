<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>산 이름 입력 및 지도 표시+관광지</title>
    <style>
        #map {
            width: 100%;
            height: 800px;
        }
    </style>
</head>

<body>
    <nav id="navbar">
        <div class="navbar__logo">
            <i class="fa-solid fa-utensils"></i>
            <a href="./mainPage.html">TrailFinder</a>
        </div>
    </nav>
    <div>
        <form id="searchForm">
            <label for="mountainName">산 이름:</label>
            <input type="text" id="mountainName" required>
            <button type="submit">검색</button>
        </form>
    </div>

    <div id="map"></div>

    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=cbd0fa5795a8ef846ce5fa0edc9696b8&libraries=services">

        </script>


    <script>

        navigator.geolocation.getCurrentPosition(function (position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;


            var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
                mapOption = {

                    center: new kakao.maps.LatLng(latitude, longitude), // 지도의 중심좌표
                    level: 5 // 지도의 확대 레벨
                };

            var map = new kakao.maps.Map(mapContainer, mapOption),
                customOverlay = new kakao.maps.CustomOverlay({}),
                infowindow = new kakao.maps.InfoWindow({ removable: true });


        });



        document.getElementById("searchForm").addEventListener("submit", function (event) {
            event.preventDefault();

            const mountainNameInput = document.getElementById("mountainName");
            const mountainName = mountainNameInput.value.trim();
            console.log(mountainName);
            if (mountainName === "") {
                return;
            }



            const requestUrl = `https://dapi.kakao.com/v2/local/search/keyword.json?query=${encodeURIComponent(mountainName)}`;

            fetch(requestUrl, {
                headers: {
                    Authorization: "KakaoAK cbf18629496639b728ece4b1fcbb27f2"
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.documents.length > 0) {
                        const mountain = data.documents[0];
                        const latitude = mountain.y; // 산의 위도
                        const longitude = mountain.x; // 산의 경도

                        // 마커를 클릭하면 장소명을 표출할 인포윈도우 입니다
                        var infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });

                        // 지도 생성
                        var mapContainer = document.getElementById('map');
                        var mapOption = {
                            center: new kakao.maps.LatLng(latitude, longitude),
                            level: 6
                        };
                        var map = new kakao.maps.Map(mapContainer, mapOption);

                        // 장소 검색 객체를 생성합니다
                        var ps = new kakao.maps.services.Places(map)

                        // 카테고리로 관광지 검색합니다
                        ps.categorySearch('AT4', placesSearchCB, { useMapBounds: true });

                        // 키워드 검색 완료 시 호출되는 콜백함수 입니다
                        function placesSearchCB(data, status, pagination) {
                            if (status === kakao.maps.services.Status.OK) {
                                for (var i = 0; i < data.length; i++) {
                                    displayMarker(data[i]);
                                }
                            }
                        }

                        // 지도에 마커를 표시하는 함수입니다
                        function displayMarker(place) {
                            // 마커를 생성하고 지도에 표시합니다
                            var marker = new kakao.maps.Marker({
                                map: map,
                                position: new kakao.maps.LatLng(place.y, place.x)
                            });

                            // 마커에 클릭이벤트를 등록합니다
                            kakao.maps.event.addListener(marker, 'click', function () {
                                // 마커를 클릭하면 장소명이 인포윈도우에 표출됩니다
                                infowindow.setContent('<div style="padding:5px;font-size:12px;">' + place.place_name + '</div>');
                                infowindow.open(map, marker);
                            });
                        }

                        // 산 위치 마커 추가
                        var markerPosition = new kakao.maps.LatLng(latitude, longitude);
                        var marker = new kakao.maps.Marker({
                            position: markerPosition
                        });
                        marker.setMap(map);

                    } else {
                        console.log("산을 찾을 수 없습니다.");
                    }
                })
                .catch(error => {
                    console.error("API 요청 중 오류가 발생했습니다.", error);
                });
        });
    </script>
</body>

</html>